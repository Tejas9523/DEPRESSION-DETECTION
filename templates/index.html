<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Diagnosis</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Basic reset and body styling */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f8ff;
            /* Light blue background for calmness */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Container for the content */
        .container {
            text-align: center;
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: static;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #2f4f4f;
            /* Dark teal for a calm, serious tone */
            font-weight: 600;
        }

        /* Icon style */
        .icon {
            margin-bottom: 20px;
            width: 60px;
            height: 60px;
            fill: #4caf50;
            /* Green color to represent mental health */
        }

        /* Style for the buttons */
        button {
            background-color: #4caf50;
            /* Green for positivity */
            color: #fff;
            border: none;
            padding: 12px 20px;
            margin: 10px 0;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #388e3c;
            /* Slightly darker green for hover effect */
        }

        button:disabled {
            background-color: #d6d6d6;
            cursor: not-allowed;
        }

        /* Icon styling inside button */
        button svg {
            margin-right: 8px;
        }

        /* Style for the download link */
        a {
            display: block;
            margin-top: 15px;
            text-decoration: none;
            color: #4caf50;
            font-size: 16px;
        }

        a:hover {
            text-decoration: underline;
        }

        .icon-btn {
            font-size: 22px;
        }

        .card {
            display: none;
            margin-left: auto;
            margin-right: auto;
            font-size: 1.5rem;
            background-color: white;
            padding: 60px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            text-align: center;
        }

        .question {
            margin: 10px;
            opacity: 0.5;
            transition: opacity 1s ease;
        }

        .question.highlight {
            opacity: 1;
            font-weight: bold;
            color: #1e90ff;
            transition: opacity 1s ease;
            transform: scale(1.05);
        }

        .question.blur {
            filter: blur(3px);
        }

        .question p {
            margin: 10px 0;
        }

        @keyframes highlight-animation {
            0% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        #recording {
            display: none;
            color: red;
            font-size: 20px;
            font-weight: bold;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        #formFileSm{
            background-color: rgb(207, 206, 206);
            padding: 5px;
            width: 300px;
        }
    </style>
</head>

<body>

    <div class="card" id="card">
        <div class="question" id="q1">
            <p>How have you been feeling emotionally over the past couple of weeks?</p>
        </div>
        <div class="question" id="q2">
            <p>What is your typical day like, and how do you feel during different parts of your day?</p>
        </div>
        <div class="question" id="q3">
            <p>Can you describe your sleep patterns recently? Have you been sleeping more or less than usual?</p>
        </div>
        <div class="question" id="q4">
            <p>How has your appetite or interest in eating changed lately?</p>
        </div>
        <div class="question" id="q5">
            <p>Have you been able to enjoy activities or hobbies that you usually like? If not, could you share why?</p>
        </div><br><br>
        <p id="recording">Recording ...</p>
    </div>


    <div class="container" id="container">
        <!-- A calming, relevant vector icon representing mental health -->
        <img src="https://www.angelinipharma.com/media/zisci2nq/ico-contenuto-11.png?mode=max&width=400&height=400&rnd=132896775664300000"
            alt="" height="200">
        <path
            d="M12 2C7.03 2 3 6.03 3 10C3 13.53 6.15 16.99 9.99 18.57C10.83 19.06 12 18.89 12 17.99V6.01C12 5.11 10.83 4.94 9.99 5.43C6.15 7.01 3 10.47 3 14C3 17.87 6.94 21 12 21C17.06 21 21 17.87 21 14C21 10.47 17.85 7.01 14.01 5.43C13.17 4.94 12 5.11 12 6.01formFileSm7.99C12 18.89 13.17 19.06 14.01 18.57C17.85 16.99 21 13.53 21 10C21 6.03 16.97 2 12 2Z" />
        </svg>

        <h1>Mental Health Diagnosis</h1>

        <!-- Buttons to control webcam recording -->
        <button id="startRecord" disabled>
            <path d="M3 12l18 0" />
            <path d="M12 3l0 18" />
            </svg>
            Start
        </button>
        <button id="stopRecord" disabled>
            <path d="M19 12l-16 0" />
            </svg>
            Finish
        </button>
        <form action="/run-assessment" method="post" id="analysisForm" enctype="multipart/form-data">
            <input class="form m-2 button" name="videoFile" accept="video/*" id="formFileSm" type="file" required>
            <button type="submit" id="analyze">Run Analysis</button>
        </form>

        <a id="downloadBtn" href="#" download="video.mp4" style="display:none;">Download Video</a>

        <!-- Progress Bar -->
        <div class="progress mt-4" style="display: none;" id="progressContainer">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%;"
                role="progressbar">
                0%
            </div>
        </div>

    </div><br>

    <script>

        // card script
        let currentQuestion = 0;
        const questions = document.querySelectorAll('.question');
        const totalQuestions = questions.length;
        alert("1. Please allow the permission to use camera and microphone \n2. Answer the questions within 40 sec each facing towards camera\n")

        // Function to reset all questions
        function resetQuestions() {
            questions.forEach(question => {
                question.classList.remove('highlight');
                question.classList.add('blur');
            });
        }

        // Function to highlight the next question
        function highlightNextQuestion() {
            resetQuestions();

            if (currentQuestion < totalQuestions) {
                const question = questions[currentQuestion];
                question.classList.remove('blur');
                question.classList.add('highlight');

                // Move to the next question after 30 seconds
                currentQuestion++;
                if (currentQuestion <= totalQuestions) {
                    setTimeout(highlightNextQuestion, 40000); // 40 seconds
                }
            }
            else {
                document.getElementById("card").style.display = "none";
                document.getElementById("container").style.display = "block";
                document.getElementById("stopRecord").style.animation = "blink 1s infinite"
            }
        }

        // container script 
        const startRecordBtn = document.getElementById('startRecord');
        const stopRecordBtn = document.getElementById('stopRecord');
        const downloadBtn = document.getElementById('downloadBtn');
        const recordingText = document.getElementById('recording');

        let mediaRecorder;
        let recordedChunks = [];
        let webcamStream, audioStream;

        document.getElementById('analyze').style.display = "none";
        document.getElementById('formFileSm').style.display = "none";


        // Start recording
        startRecordBtn.addEventListener('click', async () => {
            recordedChunks = [];
            document.getElementById("card").style.display = "block";
            document.getElementById("container").style.display = "none";
            recordingText.style.display = 'block';

            // Start the process
            highlightNextQuestion();

            try {
                // Get webcam video and audio
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Combine webcam video and audio streams
                const combinedStream = new MediaStream([
                    ...webcamStream.getTracks(),  // Add video tracks
                    ...audioStream.getTracks()    // Add audio tracks
                ]);

                // Create MediaRecorder for the combined stream
                mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const videoURL = URL.createObjectURL(blob);
                    downloadBtn.href = videoURL;
                    downloadBtn.style.display = 'inline'; // Show the download link
                    document.getElementById('formFileSm').style.display = "block";
                    startRecordBtn.style.display = "none";
                    stopRecordBtn.style.display = "none";


                    // Automatically trigger the download
                    downloadBtn.click();  // This simulates a click to start the download
                };

                mediaRecorder.start();
                startRecordBtn.disabled = true;
                stopRecordBtn.disabled = false;

            } catch (error) {
                console.error('Error capturing media:', error);
                alert('Error capturing media. Please check permissions.');
            }
        });

        // Stop recording
        stopRecordBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            webcamStream.getTracks().forEach(track => track.stop()); // Stop webcam
            audioStream.getTracks().forEach(track => track.stop());  // Stop audio
            startRecordBtn.disabled = false;
            stopRecordBtn.disabled = true;
            recordingText.style.display = 'none';
            // Automatically refresh the page
            // Refresh the page after 10 seconds (10,000 milliseconds)
            // setTimeout(function () {
            //     location.reload();
            // }, 10000);
        });

        // Function to check camera and microphone permissions
        async function checkMediaPermissions() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                // If permissions granted, enable the start button
                startRecordBtn.disabled = false;
                // Stop tracks immediately since this is just a check
                stream.getTracks().forEach(track => track.stop());
            } catch (err) {
                console.warn('Camera/Mic not accessible yet:', err);
                startRecordBtn.disabled = true;
            }
        }

        // Run the permission check on page load
        checkMediaPermissions();

        // Show analyze button if a file is selected manually
        document.getElementById("formFileSm").addEventListener("change", function () {
            if (this.files.length > 0) {
                document.getElementById("formFileSm").style.display = "none";
                document.getElementById("analyze").style.display = "block";
                document.getElementById("downloadBtn").style.display = "none";

            } else {
                document.getElementById("analyze").style.display = "none";
            }
        });

        // progressbar
        document.getElementById("analysisForm").addEventListener("submit", function () {
            document.getElementById("formFileSm").style.display = "none";
            document.getElementById("analyze").style.display = "none";
            document.getElementById("downloadBtn").style.display = "none";
            const progressBar = document.getElementById("progressBar");
            const container = document.getElementById("progressContainer");
            container.style.display = "block";

            // Simulate progress bar
            let percent = 0;
            const interval = setInterval(() => {
                if (percent < 95) {
                    percent += Math.random() * 5;
                    percent = Math.min(percent, 95);
                    progressBar.style.width = percent + "%";
                    progressBar.innerText = Math.floor(percent) + "%";
                }
            }, 300);
        });

    </script>
</body>

</html>